{"version":3,"file":"plugin-mainjs-loader.js","sources":["../../../qortal-ui-core/node_modules/epml/src/EpmlCore/Target.js","../../../qortal-ui-core/node_modules/epml/src/EpmlCore/Epml.js","../../../qortal-ui-core/node_modules/epml/src/helpers/genUUID.js","../../../qortal-ui-core/node_modules/epml/src/plugins/ready/ready.js","../../../qortal-ui-core/node_modules/epml/src/helpers/bindEvent.js","../../../qortal-ui-core/node_modules/epml/src/plugins/contentWindows/ContentWindowTarget.js","../../../qortal-ui-core/node_modules/epml/src/plugins/contentWindows/contentWindows.js","../../../qortal-ui-core/node_modules/epml/src/plugins/request/request.js","../../../qortal-ui-core/node_modules/epml/src/plugins/proxy/TwoWayMap.js","../../../qortal-ui-core/node_modules/epml/src/plugins/proxy/proxyConstants.js","../../../qortal-ui-core/node_modules/epml/src/plugins/proxy/ProxyTarget.js","../../../qortal-ui-core/node_modules/epml/src/plugins/proxy/proxy.js","../../../qortal-ui-core/node_modules/epml/src/plugins/streams/Stream.js","../../../qortal-ui-core/node_modules/epml/src/plugins/streams/stream-plugin.js","../../../qortal-ui-core/src/epml.js","../../../qortal-ui-core/src/plugins/plugin-mainjs-loader.js"],"sourcesContent":["/**\r\n * Base class for a target. Has checks in place to validate Target objects\r\n * @module Target\r\n */\r\n\r\nexport default class Target {\r\n    // // Need a static getter to check for inheritance...otherwise browser bundles can break\r\n    // static get _isInheritedFromTargetBaseClass () {\r\n    //     return true\r\n    // }\r\n    /**\r\n        * Last step before sending data. Turns it into a string (obj->JSON)\r\n        * @param {object} data\r\n        */\r\n    static prepareOutgoingData (data) {\r\n        // console.log(data)\r\n        return JSON.stringify(data)\r\n    }\r\n\r\n    constructor (source) {\r\n        if (!source) throw new Error('Source must be spcified')\r\n\r\n        // Not needed, uses type instead\r\n        // if (!this.constructor.test) throw new Error('Class requires a static `test` method in order to check whether or not a source is compatible with the constructor')\r\n\r\n        if (!this.constructor.type) throw new Error(`Type not defined`)\r\n\r\n        if (!this.constructor.name) console.warn(`No name provided`)\r\n\r\n        if (!this.constructor.description) console.warn('No description provided')\r\n\r\n        if (!this.sendMessage) throw new Error('A new target requires a sendMessage method')\r\n    }\r\n}\r\n","'use strict'\r\n\r\nimport Target from './Target.js'\r\n\r\nconst messageTypes = {}\r\nconst targetTypes = {}\r\n\r\n/**\r\n * Epml core. Useless on it's own. Needs plugins in order to \"do\" anything\r\n * @module Epml\r\n */\r\n\r\n// const epmlRequestTypeHandlers = {}\r\n// const targetConstructors = []\r\n\r\nconst allTargets = [] // No duplication\r\n// Change this to have id based targets, and therefore the ability to access any target anywhere always as long as you have it's id (don't need to pass objects around)\r\n// const allTargets = {}\r\n\r\n/**\r\n * Epml core. All plugins build off this\r\n * @constructor\r\n */\r\nexport default class Epml {\r\n    /**\r\n     * Installs a plugin \"globally\". Every new and existing epml instance will have this plugin enabled\r\n     * @param {object} plugin - Epml plugin\r\n     * @param {object} options - Options config object\r\n     */\r\n    static registerPlugin (plugin, options) {\r\n        plugin.init(Epml, options)\r\n        return Epml\r\n    }\r\n\r\n    // /**\r\n    //  * Adds a request handler function. Will be called whenever a message has a requestType corressponding to the supplied type\r\n    //  * @param {string} type - Unique request identifier\r\n    //  * @param {function} fn - Function to handle requests of this type\r\n    //  */\r\n    // static addRequestHandler (type, fn) {\r\n    //     if (epmlRequestTypeHandlers[type]) throw new Error(`${type} is already defined`)\r\n\r\n    //     epmlRequestTypeHandlers[type] = fn\r\n    // }\r\n\r\n    /**\r\n     * @typedef TargetConstructor - Target constructor. Return a Target\r\n     */\r\n    // /**\r\n    //  * Adds a new target contructor\r\n    //  * @param {TargetConstructor} TargetConstructor - Has many methods...\r\n    //  * @param {function} targetConstructor.isValidTarget - Takes a target and returns true if this constructor can handle this type of target\r\n    //  */\r\n    // static addTargetConstructor (TargetConstructor) {\r\n    //     if (!(TargetConstructor instanceof Target)) throw new Error(`TargetConstructor must inherit from the Target base class.`)\r\n    //     targetConstructors.push(TargetConstructor)\r\n    // }\r\n\r\n    static registerTargetType (type, targetConstructor) {\r\n        if (type in targetTypes) throw new Error('Target type has already been registered')\r\n        if (!(targetConstructor.prototype instanceof Target)) throw new Error('Target constructors must inherit from the Target base class')\r\n        targetTypes[type] = targetConstructor\r\n        return Epml\r\n    }\r\n\r\n    static registerEpmlMessageType (type, fn) {\r\n        messageTypes[type] = fn\r\n        return Epml\r\n    }\r\n\r\n    /**\r\n     * Installs a plugin for only this instance\r\n     * @param {object} plugin - Epml plugin\r\n     */\r\n    registerPlugin (plugin) {\r\n        plugin.init(this)\r\n        return this\r\n    }\r\n\r\n    /**\r\n     * Takes data from an event and figures out what to do with it\r\n     * @param {object} strData - String data received from something like event.data\r\n     * @param {Target} target - Target object from which the message was received\r\n     */\r\n    static handleMessage (strData, target) {\r\n        // Changes to targetID...and gets fetched through Epml.targets[targetID]...or something like that\r\n        const data = Epml.prepareIncomingData(strData)\r\n        // console.log(target)\r\n        if ('EpmlMessageType' in data) {\r\n            messageTypes[data.EpmlMessageType](data, target, this) // Reference to Epml\r\n        }\r\n        // Then send a response or whatever back with target.sendMessage(this.constructor.prepareOutgoingData(someData))\r\n    }\r\n\r\n    /**\r\n    * Prepares data for processing. Take JSON string and return object\r\n    * @param {string} strData - JSON data in string form\r\n    */\r\n    static prepareIncomingData (strData) {\r\n        if (typeof strData !== 'string') {\r\n            // If sending object is enabled then return the string...otherwise stringify and then parse (safeguard against code injections...whatever the word for that was)\r\n            return strData\r\n        }\r\n        return JSON.parse(strData)\r\n    }\r\n\r\n    /**\r\n     * Takes (a) target(s) and returns an array of target Objects\r\n     * @param {Object|Object[]} targets\r\n     * @returns {Object[]} - An array of target objects\r\n     */\r\n    static createTargets (targetSources) {\r\n        if (!Array.isArray(targetSources)) targetSources = [targetSources]\r\n\r\n        const targets = []\r\n\r\n        for (const targetSource of targetSources) {\r\n            if (targetSource.allowObjects === undefined) targetSource.allowObjects = false\r\n            targets.push(...Epml.createTarget(targetSource))\r\n        }\r\n\r\n        return targets\r\n    }\r\n\r\n    /**\r\n     * Takes a single target source and returns an array of target object\r\n     * @param {any} targetSource - Can be any target source for which a targetConstructor has been installed\r\n     * @return {Object} - Target object\r\n     */\r\n    static createTarget (targetSource) {\r\n        /*\r\n            {\r\n                source: myContentWindow / \"my_channel\" / \"myWorker.js\",\r\n                type: 'WINDOW' / 'BROADCAST_CHANNEL' / 'WORKER',\r\n                allowObjects: Bool\r\n            }\r\n        */\r\n\r\n        // const TargetConstructor = targetConstructors.find(tCtor => tCtor.test(targetSource))\r\n        // const newTarget = new TargetConstructor(targetSource)\r\n        // console.log(targetTypes, targetTypes[targetSource.type])\r\n        if (!targetTypes[targetSource.type]) {\r\n            throw new Error(`Target type '${targetSource.type}' not registered`)\r\n        }\r\n        let newTargets = new targetTypes[targetSource.type](targetSource.source)\r\n        if (!Array.isArray(newTargets)) newTargets = [newTargets]\r\n        for (const newTarget of newTargets) {\r\n            if (allTargets.indexOf(newTarget) === -1) allTargets.push(newTarget)\r\n            newTarget.allowObjects = targetSource.allowObjects\r\n        }\r\n        return newTargets\r\n    }\r\n\r\n    /**\r\n     * Creates a new Epml instance\r\n     * @constructor\r\n     * @param {Object|Object[]} targets - Target instantiation object or an array of them\r\n     */\r\n    constructor (targets) {\r\n        this.targets = this.constructor.createTargets(targets)\r\n    }\r\n}\r\n","// https://gist.github.com/LeverOne/1308368\r\nexport default (a, b) => { for (b = a = ''; a++ < 36; b += a * 51 & 52 ? (a ^ 15 ? 8 ^ Math.random() * (a ^ 20 ? 16 : 4) : 4).toString(16) : '-'); return b }\r\n\r\n// function () {\r\n//     return (1 + Math.random()).toString(36)\r\n// }\r\n","/**\r\n * Requires epml-request plugin...or not\r\n */\r\nimport genUUID from '../../helpers/genUUID.js'\r\n\r\nconst READY_CHECK_INTERVAL = 15 // ms\r\nconst READY_MESSAGE_TYPE = 'EPML_READY_STATE_CHECK'\r\nconst READY_MESSAGE_RESPONSE_TYPE = 'EPML_READY_STATE_CHECK_RESPONSE'\r\n\r\nconst pendingReadyRequests = {}\r\n\r\nconst readyPlugin = {\r\n    init: (Epml, options) => {\r\n        // if (!Epml.prototype.request) throw new Error('Requires request plugin')\r\n\r\n        if (Epml.prototype.ready) throw new Error('Epml.prototype.ready is already defined')\r\n        if (Epml.prototype.imReady) throw new Error('Epml.prototype.imReady is already defined')\r\n\r\n        Epml.prototype.ready = readyPrototype\r\n        Epml.prototype.resetReadyCheck = resetCheckReadyPrototype\r\n        Epml.prototype.imReady = imReadyPrototype\r\n\r\n        // Being asked if ready\r\n        Epml.registerEpmlMessageType(READY_MESSAGE_TYPE, respondToReadyRequest)\r\n\r\n        // Getting a response after polling for ready\r\n        Epml.registerEpmlMessageType(READY_MESSAGE_RESPONSE_TYPE, readyResponseHandler)\r\n    }\r\n}\r\n\r\n// This is the only part in the other \"window\"\r\nfunction respondToReadyRequest (data, target) {\r\n    if (!target._i_am_ready) return\r\n    target.sendMessage({\r\n        EpmlMessageType: READY_MESSAGE_RESPONSE_TYPE,\r\n        requestID: data.requestID\r\n    })\r\n}\r\n\r\nfunction imReadyPrototype () {\r\n    // console.log('I\\'m ready called', this)\r\n    for (const target of this.targets) {\r\n        target._i_am_ready = true\r\n    }\r\n    // this._ready_plugin.imReady = true\r\n}\r\n\r\n// myEpmlInstance.ready().then(...)\r\nfunction readyPrototype () {\r\n    this._ready_plugin = this._ready_plugin || {}\r\n\r\n    this._ready_plugin.pendingReadyResolves = this._ready_plugin.pendingReadyResolves ? this._ready_plugin.pendingReadyResolves : [] // Call resolves when all targets are ready\r\n\r\n    if (!this._pending_ready_checking) {\r\n        this._pending_ready_checking = true\r\n        checkReady.call(this, this.targets)\r\n            .then(() => {\r\n                this._ready_plugin.pendingReadyResolves.forEach(resolve => resolve())\r\n            })\r\n    }\r\n\r\n    return new Promise(resolve => {\r\n        if (this._ready_plugin.isReady) {\r\n            resolve()\r\n        } else {\r\n            this._ready_plugin.pendingReadyResolves.push(resolve)\r\n        }\r\n    })\r\n}\r\n\r\nfunction resetCheckReadyPrototype () {\r\n    this._ready_plugin = this._ready_plugin || {}\r\n    this._ready_plugin.isReady = false\r\n}\r\n\r\nfunction checkReady (targets) {\r\n    // console.log('Checking', targets)\r\n    this._ready_plugin = this._ready_plugin || {}\r\n    this._ready_plugin.pendingReadyResolves = []\r\n\r\n    return Promise.all(targets.map(target => {\r\n        return new Promise((resolve, reject) => {\r\n            const id = genUUID()\r\n            // Send a message at an interval.\r\n            const inteval = setInterval(() => {\r\n                // console.log('interval')\r\n                // , this, window.location\r\n                target.sendMessage({\r\n                    EpmlMessageType: READY_MESSAGE_TYPE,\r\n                    requestID: id\r\n                })\r\n            }, READY_CHECK_INTERVAL)\r\n\r\n            // Clear the interval and resolve the promise\r\n            pendingReadyRequests[id] = () => {\r\n                // console.log('RESOLVING')\r\n                clearInterval(inteval)\r\n                resolve()\r\n            }\r\n        })\r\n    })).then(() => {\r\n        this._ready_plugin.isReady = true\r\n    })\r\n}\r\n\r\n// Sets ready for a SINGLE TARGET\r\nfunction readyResponseHandler (data, target) {\r\n    // console.log('response')\r\n    // console.log('==== THIS TARGET IS REEEEEAAADDDDYYY ====')\r\n    // console.log(target)\r\n\r\n    target._ready_plugin = target._ready_plugin || {}\r\n    target._ready_plugin._is_ready = true\r\n\r\n    pendingReadyRequests[data.requestID]()\r\n}\r\n\r\nexport default readyPlugin\r\n","// IE8 event listener support...probably going to be pointless in the end\r\nexport default function bindEvent (element, eventName, eventHandler) {\r\n    if (element.addEventListener) {\r\n        element.addEventListener(eventName, eventHandler, false)\r\n    } else if (element.attachEvent) {\r\n        element.attachEvent('on' + eventName, eventHandler)\r\n    } else {\r\n        throw new Error('Could not bind event.')\r\n    }\r\n}\r\n","import Target from '../../EpmlCore/Target.js'\r\n\r\nconst sourceTargetMap = new Map()\r\n\r\n/**\r\n * Can only take ONE iframe or popup as source\r\n */\r\nclass ContentWindowTarget extends Target {\r\n    static get sources () {\r\n        return Array.from(sourceTargetMap.keys())\r\n    }\r\n\r\n    static get targets () {\r\n        return Array.from(sourceTargetMap.values())\r\n    }\r\n\r\n    static getTargetFromSource (source) {\r\n        return sourceTargetMap.get(source)\r\n    }\r\n\r\n    static hasTarget (source) {\r\n        return sourceTargetMap.has(source)\r\n    }\r\n\r\n    static get type () {\r\n        return 'WINDOW'\r\n    }\r\n\r\n    static get name () {\r\n        return 'Content window plugin'\r\n    }\r\n\r\n    static get description () {\r\n        return `Allows Epml to communicate with iframes and popup windows.`\r\n    }\r\n\r\n    static test (source) {\r\n        // if (typeof source !== 'object') return false\r\n        // console.log('FOCUS FNS', source.focus === window.focus)\r\n        // return (source === source.window && source.focus === window.focus) // <- Cause cors is a beach\r\n        // return (typeof source === 'object' && source.focus === window.focus)\r\n        return (typeof source === 'object' && source === source.self)\r\n    }\r\n\r\n    isFrom (source) {\r\n        //\r\n    }\r\n\r\n    constructor (source) {\r\n        super(source)\r\n\r\n        // if (source.contentWindow) source = source.contentWindow // <- Causes issues when cross origin\r\n\r\n        // If the source already has an existing target object, simply return it.\r\n        if (sourceTargetMap.has(source)) return sourceTargetMap.get(source)\r\n\r\n        if (!this.constructor.test(source)) throw new Error('Source can not be used with target')\r\n\r\n        this._source = source\r\n\r\n        // SHOULD MODIFY. Should become source = { contentWindow, origin } rather than source = contentWindow\r\n        // try {\r\n        //     this._sourceOrigin = source.origin\r\n        // } catch (e) {\r\n        //     // Go away CORS\r\n        //     this._sourceOrigin = '*'\r\n        // }\r\n        this._sourceOrigin = '*'\r\n\r\n        sourceTargetMap.set(source, this)\r\n\r\n        // targetWindows.push(source)\r\n    }\r\n\r\n    get source () {\r\n        return this._source\r\n    }\r\n\r\n    sendMessage (message) {\r\n        message = Target.prepareOutgoingData(message)\r\n        this._source.postMessage(message, this._sourceOrigin)\r\n    }\r\n}\r\nexport default ContentWindowTarget\r\n","'use strict'\r\n\r\nimport bindEvent from '../../helpers/bindEvent.js'\r\nimport ContentWindowTarget from './ContentWindowTarget.js'\r\n/**\r\n * Epml content windows plugin. Enables communication with iframes and popup windows\r\n */\r\nexport default {\r\n    init: function (Epml) {\r\n        // const proto = Epml.prototype\r\n\r\n        bindEvent(window, 'message', event => {\r\n            // console.log(event)\r\n            if (!ContentWindowTarget.hasTarget(event.source)) return\r\n            Epml.handleMessage(event.data, ContentWindowTarget.getTargetFromSource(event.source))\r\n            // Epml.handleMessage(event.data, event.source, message => {\r\n            //     event.source.postMessage(message, event.origin)\r\n            // })\r\n        })\r\n\r\n        // Epml.addTargetConstructor(ContentWindowTarget)\r\n        Epml.registerTargetType(ContentWindowTarget.type, ContentWindowTarget)\r\n\r\n        // Epml.addTargetHandler({\r\n        //     targetType: 'WINDOW', // Unique type for each target type\r\n        //     name: 'Content window',\r\n        //     description: 'Allows Epml to communicate with iframes and popup windows',\r\n        //     isMatchingTargetSource: function (source) {\r\n        //         if (typeof source !== 'object') return false\r\n\r\n        //         source = source.contentWindow || source\r\n        //     },\r\n        //     createTarget: function (source) {\r\n        //         targetWindows.push({\r\n        //             source,\r\n        //             eventIsFromSource: function (event) {\r\n        //                 if (event.source === source) return true\r\n        //                 return false\r\n        //             }\r\n        //         })\r\n        //         return {\r\n        //             sendMessage: function (data) {\r\n        //                 return source.postMessage(data, source.origin)\r\n        //             }\r\n        //         }\r\n        //     }\r\n        // })\r\n    }\r\n}\r\n","'use strict'\r\n\r\nimport genUUID from '../../helpers/genUUID.js'\r\n// import Target from '../../EpmlCore/Target.js'\r\n\r\nconst REQUEST_MESSAGE_TYPE = 'REQUEST'\r\nconst REQUEST_RESPONSE_MESSAGE_TYPE = 'REQUEST_RESPONSE'\r\n\r\n/**\r\n * Epml request module. Wrapper for asynchronous requests and responses (routes)\r\n * @module plugins/request/request.js\r\n */\r\n// Maps a target to an array of routes\r\nconst routeMap = new Map()\r\n\r\nconst pendingRequests = {}\r\n\r\n/**\r\n * Request plugin\r\n */\r\nconst requestPlugin = {\r\n    init: (Epml, options) => {\r\n        if (Epml.prototype.request) throw new Error('Epml.prototype.request is already defined')\r\n\r\n        if (Epml.prototype.route) throw new Error(`Empl.prototype.route is already defined`)\r\n\r\n        Epml.prototype.request = requestFn\r\n\r\n        Epml.prototype.route = createRoute\r\n\r\n        Epml.registerEpmlMessageType(REQUEST_MESSAGE_TYPE, requestHandler)\r\n        Epml.registerEpmlMessageType(REQUEST_RESPONSE_MESSAGE_TYPE, requestResponseHandler)\r\n    }\r\n}\r\n\r\nconst requestFn = function (requestType, data, timeout) {\r\n    // console.log(this)\r\n    return Promise.all(this.targets.map(target => {\r\n        const uuid = genUUID()\r\n\r\n        const message = {\r\n            EpmlMessageType: REQUEST_MESSAGE_TYPE,\r\n            requestOrResponse: 'request',\r\n            requestID: uuid,\r\n            requestType,\r\n            data // If data is undefined it's simply omitted :)\r\n        }\r\n\r\n        target.sendMessage(message)\r\n\r\n        return new Promise((resolve, reject) => {\r\n            // console.log('PROMISEEEE')\r\n            let timeOutFn\r\n            if (timeout) {\r\n                timeOutFn = setTimeout(() => {\r\n                    delete pendingRequests[uuid]\r\n                    reject(new Error('Request timed out'))\r\n                }, timeout)\r\n            }\r\n\r\n            pendingRequests[uuid] = (...args) => {\r\n                if (timeOutFn) clearTimeout(timeOutFn)\r\n                resolve(...args)\r\n            }\r\n            // console.log(pendingRequests)\r\n        })\r\n    }))\r\n        .then(responses => {\r\n            // console.log(responses)\r\n            // If an instance only has one target, don't return the array. That'd be weird\r\n            if (this.targets.length === 1) return responses[0]\r\n        })\r\n}\r\n\r\nfunction requestResponseHandler (data, target, Epml) {\r\n    // console.log(\"REQUESSTTT\", data, pendingRequests)\r\n    // console.log('IN REQUESTHANDLER', pendingRequests, data)\r\n    if (data.requestID in pendingRequests) {\r\n        // console.log(data)\r\n        // const parsedData = Epml.prepareIncomingData(data.data)\r\n        const parsedData = data.data\r\n        // const parsedData = data.data\r\n        pendingRequests[data.requestID](parsedData)\r\n    } else {\r\n        console.warn('requestID not found in pendingRequests')\r\n    }\r\n}\r\n\r\nfunction requestHandler (data, target) {\r\n    // console.log('REQUESTHANLDER')\r\n    // console.log(routeMap)\r\n    // console.log(data)\r\n    // console.log(target)\r\n    if (!routeMap.has(target)) {\r\n        // Error, route does not exist\r\n        console.warn(`Route does not exist - missing target`)\r\n        return\r\n    }\r\n    const routes = routeMap.get(target)\r\n    // console.log(data, routes)\r\n    const route = routes[data.requestType]\r\n    if (!route) {\r\n        // Error, route does not exist\r\n        console.warn('Route does not exist')\r\n        return\r\n    }\r\n    // console.log('CALLING FN')\r\n    route(data, target)\r\n}\r\n\r\nfunction createRoute (route, fn) {\r\n    // console.log(`CREATING ROUTTTEEE \"${route}\"`)\r\n    if (!this.routes) this.routes = {}\r\n\r\n    if (this.routes[route]) return\r\n\r\n    for (const target of this.targets) {\r\n        if (!routeMap.has(target)) {\r\n            routeMap.set(target, {})\r\n        }\r\n\r\n        const routes = routeMap.get(target)\r\n\r\n        routes[route] = (data, target) => {\r\n            // console.log('ROUTE FN CALLED', data)\r\n            // User supllied route function. This will turn it into a promise if it isn't one, or it will leave it as one.\r\n            Promise.resolve(fn(data))\r\n                .catch(err => {\r\n                    if (err instanceof Error) return err.message\r\n                    return err\r\n                }) // Still send errors you dumb fuck\r\n                .then((response) => {\r\n                    // console.log(response)\r\n                    // response = this.constructor.prepareOutgoingData(response)\r\n                    // const preparedResponse = Target.prepareOutgoingData(response)\r\n                    target.sendMessage({\r\n                        data: response, // preparedResponse\r\n                        EpmlMessageType: REQUEST_RESPONSE_MESSAGE_TYPE,\r\n                        requestOrResponse: 'request',\r\n                        requestID: data.requestID\r\n                    })\r\n                })\r\n        }\r\n    }\r\n\r\n    // console.log('hello')\r\n}\r\n\r\nexport default requestPlugin\r\n","class TwoWayMap {\r\n    constructor (map) {\r\n        this._map = map || new Map()\r\n        this._revMap = new Map()\r\n\r\n        this._map.forEach((key, value) => {\r\n            this._revMap.set(value, key)\r\n        })\r\n    }\r\n\r\n    values () {\r\n        return this._map.values()\r\n    }\r\n\r\n    entries () {\r\n        return this._map.entries()\r\n    }\r\n\r\n    push (key, value) {\r\n        this._map.set(key, value)\r\n        this._revMap.set(value, key)\r\n    }\r\n\r\n    getByKey (key) {\r\n        return this._map.get(key)\r\n    }\r\n\r\n    getByValue (value) {\r\n        return this._revMap.get(value)\r\n    }\r\n\r\n    hasKey (key) {\r\n        return this._map.has(key)\r\n    }\r\n\r\n    hasValue (value) {\r\n        return this._revMap.has(value)\r\n    }\r\n\r\n    deleteByKey (key) {\r\n        const value = this._map.get(key)\r\n        this._map.delete(key)\r\n        this._revMap.delete(value)\r\n    }\r\n\r\n    deleteByValue (value) {\r\n        const key = this._revMap.get(value)\r\n        this._map.delete(key)\r\n        this._revMap.delete(value)\r\n    }\r\n}\r\n\r\nexport default TwoWayMap\r\n","const PROXY_MESSAGE_TYPE = 'PROXY_MESSAGE'\r\n\r\nexport { PROXY_MESSAGE_TYPE }\r\n","// Proxy target source will be another instance of epml. The source instance will be the proxy. The extra parameter will be the target for that proxy\r\n\r\nimport Target from '../../EpmlCore/Target.js'\r\nimport genUUID from '../../helpers/genUUID.js'\r\nimport TwoWayMap from './TwoWayMap.js'\r\n// import { PROXY_MESSAGE_TYPE } from './proxyConfig.js'\r\nimport { PROXY_MESSAGE_TYPE } from './proxyConstants.js'\r\n\r\n// Stores source.proxy => new Map([[source.target, new ProxyTarget(source)]])\r\nconst proxySources = new TwoWayMap()\r\n\r\n/**\r\n *  source = {\r\n *      target:'frame1',\r\n *      proxy: epmlInstance\r\n *  }\r\n */\r\n\r\n/**\r\n * Can only take ONE iframe or popup as source\r\n */\r\nclass ProxyTarget extends Target {\r\n    static get proxySources () {\r\n        return proxySources\r\n    }\r\n\r\n    static get sources () {\r\n        const sources = []\r\n        for (const [proxySource, valueMap] of proxySources) {\r\n            for (const [target] of valueMap) {\r\n                sources.push({\r\n                    target,\r\n                    proxy: proxySource\r\n                })\r\n            }\r\n        }\r\n        Array.from(proxySources.entries()).map((sourceProxy, valueMap) => {\r\n            return {\r\n                proxy: sourceProxy,\r\n                target: Array.from(valueMap.keys())[0]\r\n            }\r\n        })\r\n    }\r\n    // ==================================================\r\n    // ALL THIS NEEDS REWORKING. BUT PROBABLY NOT URGENT\r\n    // ==================================================\r\n    static get targets () {\r\n        return Array.from(proxySources.values())\r\n    }\r\n\r\n    static getTargetFromSource (source) {\r\n        return proxySources.getByValue(source)\r\n    }\r\n\r\n    static hasTarget (source) {\r\n        return proxySources.hasValue(source)\r\n    }\r\n\r\n    static get type () {\r\n        return 'PROXY'\r\n    }\r\n\r\n    static get name () {\r\n        return 'Proxy target'\r\n    }\r\n\r\n    static get description () {\r\n        return `Uses other target, and proxies requests, allowing things like iframes to communicate through their host`\r\n    }\r\n\r\n    static test (source) {\r\n        if (typeof source !== 'object') return false\r\n        // console.log('FOCUS FNS', source.focus === window.focus)\r\n        if (!(source.proxy instanceof this.Epml)) return false\r\n        // return (source === source.window && source.focus === window.focus)\r\n        return true\r\n    }\r\n\r\n    isFrom (source) {\r\n        //\r\n    }\r\n\r\n    // Bit different to a normal target, has a second parameter\r\n    constructor (source) {\r\n        super(source)\r\n        /**\r\n         * Source looks like {proxy: epmlInstance, target: 'referenceToTargetInProxy'}\r\n         */\r\n\r\n        this.constructor.proxySources.push(source.id, this)\r\n\r\n        if (!this.constructor.test(source)) throw new Error('Source can not be used with target')\r\n\r\n        this._source = source\r\n    }\r\n\r\n    get source () {\r\n        return this._source\r\n    }\r\n\r\n    sendMessage (message) {\r\n        // ID for the proxy\r\n        const uuid = genUUID()\r\n\r\n        message = Target.prepareOutgoingData(message)\r\n\r\n        message = {\r\n            EpmlMessageType: PROXY_MESSAGE_TYPE,\r\n            // proxyMessageType: 'REQUEST',\r\n            state: 'TRANSIT',\r\n            requestID: uuid,\r\n            target: this._source.target, // 'frame1' - the registered name\r\n            message,\r\n            id: this._source.id\r\n        }\r\n\r\n        // console.log(this._source)\r\n        // Doesn't need to loop through, as a proxy should only ever have a single proxy target (although the target can have multiple...it just shouldn't send THROUGH multiple targets)\r\n        this._source.proxy.targets[0].sendMessage(message)\r\n        // this._source.proxy.targets.forEach(target => target.sendMessage(messaage))\r\n    }\r\n}\r\n\r\nexport default ProxyTarget\r\n","// Proxy is a \"normal\" target, but it intercepts the message, changes the type, and passes it on to the target window, where it's received by the proxy handler...message type reverted, and passed to handleMessage with the actual target\r\n'use strict'\r\n\r\nimport ProxyTarget from './ProxyTarget.js'\r\n\r\nimport { PROXY_MESSAGE_TYPE } from './proxyConstants.js'\r\n// import Target from '../../EpmlCore/Target.js';\r\n// Stores id => target (and reverse). Can be used in the host and the target...targets just have different roles :)\r\n// const proxySources = new TwoWayMap() // Map id to it's target :) OOOHHHHH....MAYBE THIS SHOULD BE IN THE PROXYTARGET...AND IT GET ACCESSED FROM HERE. DUH!!!\r\n// ProxyTarget.proxySources = proxySources // :)\r\nconst proxySources = ProxyTarget.proxySources\r\n// There will be two message states....transit or delivery. Transit is sent to the proxy....delivery is sent to the target....the source simply being the target in the opposit direction\r\n\r\nlet EpmlReference\r\n\r\nexport default {\r\n    init: function (Epml) {\r\n        // const proto = Epml.prototype\r\n\r\n        Object.defineProperty(ProxyTarget, 'Epml', {\r\n            get: () => Epml\r\n        })\r\n\r\n        // So that the below functions can access\r\n        EpmlReference = Epml\r\n\r\n        // Epml.addTargetConstructor(ContentWindowTarget)\r\n        Epml.registerTargetType(ProxyTarget.type, ProxyTarget)\r\n\r\n        Epml.registerProxyInstance = registerProxyInstance\r\n\r\n        Epml.registerEpmlMessageType(PROXY_MESSAGE_TYPE, proxyMessageHandler)\r\n    }\r\n}\r\n\r\nfunction proxyMessageHandler (data, target) {\r\n    // console.log(data)\r\n    // SWITCH BASED ON STATE === TRANSIT OR DELIVERY\r\n    // If it's in transit, then look up the id in the map and pass the corresponding target...\r\n    // YES! Instead of creating a new target that will translate to send to the thing....you look up the source's id....it will (have to) correspond to the source object created in this window :)\r\n\r\n    if (data.state === 'TRANSIT') {\r\n        // This fetches an epml instance which has the id, and so has the targets inside of it...i guess\r\n        const targetInstance = proxySources.getByKey(data.target)\r\n        if (!targetInstance) {\r\n            console.warn(`Target ${data.target} not registered.`)\r\n            return\r\n        }\r\n\r\n        data.state = 'DELIVERY'\r\n        // console.log(targetInstance)\r\n        targetInstance.targets.forEach(target => target.sendMessage(data))\r\n        // targets.targets[0].sendMessage(data)\r\n    } else if (data.state === 'DELIVERY') {\r\n        // This target is a target created through type: proxy\r\n        const targetInstance = proxySources.getByKey(data.target)\r\n        if (!targetInstance) {\r\n            console.warn(`Target ${data.target} not registered.`)\r\n            return\r\n        }\r\n        const target = proxySources.getByKey(data.target)\r\n        // console.log(target)\r\n        // console.log(proxySources)\r\n        // console.log(data)\r\n        EpmlReference.handleMessage(data.message, target)\r\n    }\r\n}\r\n\r\n// NOT A TARGET....IT'S AN EPML INSTANCE\r\nfunction registerProxyInstance (id, target) {\r\n    // console.log(target, id)\r\n    if (proxySources.hasKey(id)) console.warn(`${id} is already defined. Overwriting...`)\r\n    proxySources.push(id, target)\r\n    // console.log(proxySources)\r\n}\r\n\r\n// I need to pass the proxySources twowaymap to the proxyTarget object, so that any new target created through it can be pushed to it\r\n","import Target from '../../EpmlCore/Target.js'\r\n\r\nexport const STREAM_UPDATE_MESSAGE_TYPE = 'STREAM_UPDATE'\r\n\r\nconst allStreams = {} // Maybe not even needed\r\n\r\nexport class EpmlStream {\r\n    static get streams () {\r\n        return allStreams\r\n    }\r\n\r\n    constructor (name, subscriptionFn = () => {}) {\r\n        this._name = name // Stream name\r\n        this.targets = [] // Targets listening to the stream\r\n        this._subscriptionFn = subscriptionFn // Called on subscription, whatever it returns we send to the new target\r\n        if (name in allStreams) {\r\n            console.warn(`Stream with name ${name} already exists! Returning it instead`)\r\n            return allStreams[name]\r\n        }\r\n        allStreams[name] = this\r\n    }\r\n\r\n    async subscribe (target) {\r\n        if (target in this.targets) {\r\n            console.info('Target is already subscribed to this stream')\r\n        }\r\n        const response = await this._subscriptionFn()\r\n        this._sendMessage(response, target)\r\n        this.targets.push(target)\r\n    }\r\n\r\n    _sendMessage (data, target) {\r\n        target.sendMessage({\r\n            data: Target.prepareOutgoingData(data),\r\n            EpmlMessageType: STREAM_UPDATE_MESSAGE_TYPE,\r\n            streamName: this._name\r\n        })\r\n    }\r\n\r\n    emit (data) {\r\n        this.targets.forEach(target => this._sendMessage(data, target))\r\n    }\r\n}\r\n","'use strict'\r\n\r\nimport { EpmlStream, STREAM_UPDATE_MESSAGE_TYPE } from './Stream.js'\r\n\r\nexport { EpmlStream }\r\n\r\nconst JOIN_STREAM_MESSAGE_TYPE = 'JOIN_STREAM'\r\n\r\n/**\r\n * Epml streams module. Wrapper for asynchronous requests and responses (routes)\r\n * @module plugins/request/request.js\r\n */\r\n// Maps a target to an array of routes\r\n// const routeMap = new Map()\r\n\r\n// const pendingRequests = {}\r\n\r\n// allStreams = Streams.allStreams\r\n\r\n// // Server\r\n// const targetsToStreamsMap = new Map()\r\n\r\n// // Client\r\nconst subscriptions = {}\r\n\r\n/**\r\n * Request plugin\r\n */\r\nexport const EpmlStreamPlugin = {\r\n    init: (Epml, options) => {\r\n        // if (Epml.prototype.connectStream) throw new Error('Epml.prototype.connectStream is already defined')\r\n        if (Epml.prototype.subscribe) throw new Error('Epml.prototype.subscribe is already defined')\r\n\r\n        if (Epml.prototype.createStream) throw new Error(`Empl.prototype.createStream is already defined`)\r\n\r\n        Epml.prototype.subscribe = subscribe\r\n\r\n        Epml.registerEpmlMessageType(JOIN_STREAM_MESSAGE_TYPE, joinStream)\r\n        Epml.registerEpmlMessageType(STREAM_UPDATE_MESSAGE_TYPE, receiveData)\r\n    }\r\n}\r\n\r\n// 'server'side...on the side of myStream = new Stream('myStream'[, joinFn]).\r\nconst joinStream = function (req, target) {\r\n    // if (!targetsToStreamsMap.has(target)) {\r\n    //     // Error, route does not exist\r\n    //     console.warn(`Stream does not exist - missing target`)\r\n    //     return\r\n    // }\r\n    const name = req.data.name\r\n    // const streamToJoin = targetsToStreamsMap.get(target)[name]\r\n    const streamToJoin = EpmlStream.streams[name]\r\n    if (!streamToJoin) {\r\n        console.warn(`No stream with name ${name}`, this)\r\n        return\r\n    }\r\n\r\n    streamToJoin.subscribe(target)\r\n}\r\n\r\n// Gives an Epml instance access to a stream...maybe\r\n// const connectStream = function (streamInstance) {\r\n//     //\r\n// }\r\n\r\n// No such thing as Epml.createStream...just myStream = new Epml.Stream()\r\n\r\n// Client side\r\n// EpmlInstance.subscribe(...)\r\nconst subscribe = function (name, listener) {\r\n    this.targets.forEach(target => {\r\n        target.sendMessage({\r\n            EpmlMessageType: JOIN_STREAM_MESSAGE_TYPE,\r\n            data: { name }\r\n        })\r\n    })\r\n    subscriptions[name] = subscriptions[name] || []\r\n    subscriptions[name].push(listener)\r\n}\r\n// Client side\r\n// Called on STREAM_UPDATE_MESSAGE_TYPE message\r\nconst receiveData = function (message, target) {\r\n    // console.log('data', message, target)\r\n    subscriptions[message.streamName].forEach(listener => listener(message.data))\r\n}\r\n","import { Epml, EpmlReadyPlugin, RequestPlugin, ContentWindow as EpmlContentWindowPlugin, EpmlStreamPlugin, EpmlProxyPlugin, EpmlStream } from 'epml'\n\n// Epml.registerPlugin(contentWindowsPlugin)\nEpml.registerPlugin(RequestPlugin)\nEpml.registerPlugin(EpmlReadyPlugin)\nEpml.registerPlugin(EpmlContentWindowPlugin)\nEpml.registerPlugin(EpmlStreamPlugin)\nEpml.registerPlugin(EpmlProxyPlugin)\nEpml.allowProxying = true\n\nexport { Epml, EpmlStream }\n","'use strict'\nimport { Epml, EpmlStream } from '../epml.js'\n// import { ContentWindow } from 'epml'\n\n// Epml.registerPlugin(ContentWindow)\n\nwindow.Epml = Epml\nwindow.EpmlStream = EpmlStream\n\nconst pluginScript = document.createElement('script')\npluginScript.async = false\npluginScript.type = 'module'\nconst hash = window.location.hash\n// console.log(hash)\npluginScript.src = '/plugin/' + hash.slice(1)\n// pluginScript.src = window.location.protocol + '//' + hash.slice(1) + '.' + window.location.hostname + '/main.js'\n// pluginScript.src = '/main.js'\n// console.log(pluginScript.src)\ndocument.body.appendChild(pluginScript)\n"],"names":["Target","prepareOutgoingData","data","JSON","stringify","constructor","source","Error","type","name","console","warn","description","sendMessage","messageTypes","targetTypes","Epml","registerPlugin","plugin","options","init","registerTargetType","targetConstructor","prototype","registerEpmlMessageType","fn","handleMessage","strData","target","prepareIncomingData","EpmlMessageType","parse","createTargets","targetSources","Array","isArray","targets","targetSource","allowObjects","undefined","push","createTarget","newTargets","newTarget","a","b","Math","random","toString","READY_CHECK_INTERVAL","READY_MESSAGE_TYPE","READY_MESSAGE_RESPONSE_TYPE","pendingReadyRequests","readyPlugin","ready","imReady","readyPrototype","resetReadyCheck","resetCheckReadyPrototype","imReadyPrototype","respondToReadyRequest","readyResponseHandler","_i_am_ready","requestID","_ready_plugin","pendingReadyResolves","_pending_ready_checking","checkReady","call","then","forEach","resolve","Promise","isReady","all","map","reject","id","genUUID","inteval","setInterval","clearInterval","_is_ready","bindEvent","element","eventName","eventHandler","addEventListener","attachEvent","sourceTargetMap","Map","ContentWindowTarget","sources","from","keys","values","getTargetFromSource","get","hasTarget","has","test","self","isFrom","_source","_sourceOrigin","set","message","postMessage","window","event","REQUEST_MESSAGE_TYPE","REQUEST_RESPONSE_MESSAGE_TYPE","routeMap","pendingRequests","requestPlugin","request","route","requestFn","createRoute","requestHandler","requestResponseHandler","requestType","timeout","uuid","requestOrResponse","timeOutFn","setTimeout","args","clearTimeout","responses","length","parsedData","routes","catch","err","response","TwoWayMap","_map","_revMap","key","value","entries","getByKey","getByValue","hasKey","hasValue","deleteByKey","delete","deleteByValue","PROXY_MESSAGE_TYPE","proxySources","ProxyTarget","proxySource","valueMap","sourceProxy","proxy","state","EpmlReference","Object","defineProperty","registerProxyInstance","proxyMessageHandler","targetInstance","STREAM_UPDATE_MESSAGE_TYPE","allStreams","EpmlStream","streams","subscriptionFn","_name","_subscriptionFn","subscribe","info","_sendMessage","streamName","emit","JOIN_STREAM_MESSAGE_TYPE","subscriptions","EpmlStreamPlugin","createStream","joinStream","receiveData","req","streamToJoin","listener","RequestPlugin","EpmlReadyPlugin","EpmlContentWindowPlugin","EpmlProxyPlugin","allowProxying","pluginScript","document","createElement","async","hash","location","src","slice","body","appendChild"],"mappings":"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"}